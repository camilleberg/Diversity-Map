values = ~ current_data,
title = legend_label,
opacity = 1,
na.label = 'Tracts with little or no population')
pob_diversity_tract <- readRDS("~/GitHub/Diversity-Map/output/pob_diversity_tract.RDS")
{input <- "val_pob_us_regions"
tract_df <- pob_diversity_tract
scale_bool <- T
}
{
tract_df <- tract_df %>% st_as_sf()
selected_val <- str_sub(input, start = 5)
tract_df$current_data <- tract_df[[input]]
# reading in the data
p_all <- paste0("./graph_files/", list.files(path = "./graph_files/", pattern = selected_val)) %>% readRDS()
p_tracts <-tibble::enframe(p_all) %>% tidyr::pivot_wider() %>% t()
tract_df <- tract_df %>%
mutate(pie_graph = p_tracts)
NUM_VARIABLES <- tract_df %>%
select(starts_with(selected_val)) %>%
ncol() - 1
max_val <- 1 - (1/(NUM_VARIABLES))
jank_minimum <- tract_df[tract_df$NAME == 'Census Tract 9815.01, Suffolk County, Massachusetts',]
jank_minimum$current_data <- 0
#jank_minimum$geometry <- list(list(c(-71.136596, -71.136273, 42.360161, 42.360903)))
jank_minimum$NAME <- 'min_val'
tract_df <- rbind(jank_minimum %>% st_as_sf(), tract_df)
jank_max <- tract_df[tract_df$NAME == 'Census Tract 9813, Suffolk County, Massachusetts',]
jank_max$current_data <- max_val
jank_max$NAME <- 'max_val'
tract_df <- rbind(jank_max, tract_df)
#tract_df <- tract_df %>% st_as_sf()
pal_option <- "RdYlBu"
# pal_option <- addalpha(pal_option, alpha = .5)
#pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
if (scale_bool){
#####FIGURE OUT WHY I NEED TO SUBTRACT 1
pal <- colorNumeric(palette = pal_option, domain = c(0, max_val),
na.color = "#505050")
legend_label <- "Diversity Index Score"
}else {
pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
legend_label <- "Percentile of Diversity Index"
}
}
tract_df %>%
mutate(current_data = ifelse(startsWith(NAME, "Census Tract 98"), NaN,current_data)) %>%
st_transform(crs = "+init=epsg:4326") %>%
leaflet() %>%
addTiles() %>%
addProviderTiles(provider = "CartoDB.Positron")  %>%
addPolygons(
stroke = F,
smoothFactor = 0,
fillOpacity = 0.7,
color = ~ pal(current_data), group = 'current_data',
popup = popupGraph(p_all)
) %>%
addLegend("bottomright",
pal = pal,
values = ~ current_data,
title = legend_label,
opacity = 1,
na.label = 'Tracts with little or no population')
shiny::runApp('mapnew')
runApp('mapnew')
runApp('mapnew')
rm(list = ls())
library(tidycensus)
library(tidyverse)
library(leaflet)
library(leafpop)
library(mapview)
library(sf)
library(stringr)
library(plotly)
library(readr)
library(readxl)
library(stringr)
library(dplyr)
library(htmlwidgets)
# reading in all the data from the output folder
setwd("./output")
all_tract_data <- list.files(pattern = "tract.RDS") %>%
map(readRDS)
setwd("..")
# separating out the div values
for(i in 1:length(all_tract_data)) {
temp <- all_tract_data[[i]] %>% as_tibble()
var_name <- strsplit(colnames(temp)[4], "_")[[1]][1]
assign(paste0(var_name, "_values"), temp, envir = .GlobalEnv)
}
# for str wrap
pie_legend_label_fxn <- function(pie_label_name) {
return(paste(strwrap(pie_label_name, width = 25), collapse = "<br>"))
}
# need input and tract_df
PIE_CHART_TRACT_FUNC <- function(tract_name, tract_df_graph, selected_val){
tract_df_graph <- tract_df_graph %>% filter(NAME == paste0(tract_name))
# labeling variables
pie_labels <- colnames(tract_df_graph) %>% str_sub(start = str_length(selected_val) + 2) %>% str_replace_all("_", " ")
pie_labels <- lapply(pie_labels, pie_legend_label_fxn) %>% unlist()
pie_labels <- pie_labels %>% factor(levels = pie_labels, ordered = T)
pie_values <- as.numeric(as.vector(tract_df_graph[1,]))
# creating the graph
pie_chart <- plot_ly(labels = ~pie_labels, values = ~pie_values,
type = 'pie', sort = F,
marker = list(colors = c("#fdb462","#8dd3c7","#ffffb3","#bebada","#b3de69",
"#fccde5","#d9d9d9","#9c755f","#d37295","#00ffd0","#9467bd"))) %>%
layout(title = strsplit(paste0(tract_name), ",")[[1]][1],
xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
pie_chart
}
# uses tghe chart function to make all the charts per tracts
# and also converts it into a useable format
plot_html_fxn <- function(tract_df, input) {
# Gets rid of prefix. Used for starts with functionality
selected_val <- str_sub(input, start = 5)
tract_df_graph <- tract_df %>%
select(c(NAME, starts_with(selected_val)))
# this creates the chart for each tract and stores them as a list
p_all_plotly <- lapply(tract_df$NAME, PIE_CHART_TRACT_FUNC,
tract_df_graph = tract_df_graph,
selected_val = selected_val)
# this writes the list file as an external html file
# this is nec to add as a popup in leaflet maps (idk why tho)
p_all_plotly_html <- lapply(p_all_plotly, function(plot) {
fl = tempfile(fileext = ".html")
saveWidget(plot, file = fl, selfcontained = TRUE)
return(fl)
}
)
write_rds(p_all_plotly, paste0("graph_files/graph_", selected_val, ".RDS"))
}
# function to write input values
input_val_fxn <- function(tract_df) {
var <- strsplit(deparse(substitute(tract_df)), "_")[[1]][1]
input_vals <- colnames(tract_df)[grepl("^val_", colnames(tract_df))]
assign(paste0(var, "_input_vals"), input_vals, envir = .GlobalEnv)
}
# in case the oter thing (below) doesn't work
plot_output_fxn <- function(tract_df) {
input_vals <- colnames(tract_df)[grepl("^val_", colnames(tract_df))]
for(i in 1:length(input_vals)) {
plot_html_fxn(tract_df = tract_df, input_vals[i])
}
}
plot_output_fxn(race_values)
plot_output_fxn(pob_values)
plot_output_fxn(age_values)
plot_output_fxn(hh_values)
plot_output_fxn(lang_values)
plot_output_fxn(educ_values)
runApp('mapnew')
runApp('mapnew')
runApp('mapnew')
runApp('mapnew')
runApp('mapnew')
{input <- "val_pob_us_regions"
tract_df <- pob_values
scale_bool <- T
}
{
tract_df <- tract_df %>% st_as_sf()
selected_val <- str_sub(input, start = 5)
tract_df$current_data <- tract_df[[input]]
# reading in the data
p_all <- paste0("./graph_files/", list.files(path = "./graph_files/", pattern = selected_val)) %>% readRDS()
p_tracts <-tibble::enframe(p_all) %>% tidyr::pivot_wider() %>% t()
tract_df <- tract_df %>%
mutate(pie_graph = p_tracts)
NUM_VARIABLES <- tract_df %>%
select(starts_with(selected_val)) %>%
ncol() - 1
max_val <- 1 - (1/(NUM_VARIABLES))
jank_minimum <- tract_df[tract_df$NAME == 'Census Tract 9815.01, Suffolk County, Massachusetts',]
jank_minimum$current_data <- 0
#jank_minimum$geometry <- list(list(c(-71.136596, -71.136273, 42.360161, 42.360903)))
jank_minimum$NAME <- 'min_val'
tract_df <- rbind(jank_minimum %>% st_as_sf(), tract_df)
jank_max <- tract_df[tract_df$NAME == 'Census Tract 9813, Suffolk County, Massachusetts',]
jank_max$current_data <- max_val
jank_max$NAME <- 'max_val'
tract_df <- rbind(jank_max, tract_df)
#tract_df <- tract_df %>% st_as_sf()
pal_option <- "RdYlBu"
# pal_option <- addalpha(pal_option, alpha = .5)
#pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
if (scale_bool){
#####FIGURE OUT WHY I NEED TO SUBTRACT 1
pal <- colorNumeric(palette = pal_option, domain = c(0, max_val),
na.color = "#505050")
legend_label <- "Diversity Index Score"
}else {
pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
legend_label <- "Percentile of Diversity Index"
}
}
tract_df %>%
mutate(current_data = ifelse(startsWith(NAME, "Census Tract 98"), NaN,current_data)) %>%
st_transform(crs = "+init=epsg:4326") %>%
leaflet() %>%
addTiles() %>%
addProviderTiles(provider = "CartoDB.Positron")  %>%
addPolygons(
stroke = F,
smoothFactor = 0,
fillOpacity = 0.7,
color = ~ pal(current_data), group = 'current_data',
popup = popupGraph(p_all)
) %>%
addLegend("bottomright",
pal = pal,
values = ~ current_data,
title = legend_label,
opacity = 1,
na.label = 'Tracts with little or no population')
runApp('mapnew')
runApp('mapnew')
runApp('mapnew')
runApp('mapnew')
runApp('mapnew')
runApp('mapnew')
runApp('mapnew')
runApp('mapnew')
setwd("~/GitHub/Diversity-Map/mapnew")
read_rds("graph_files/graph_race_seven.RDS")
# p_all <- paste0("./graph_files/", list.files(path = "./graph_files/", pattern = selected_val)) %>% read_rds()
popup_test <- read_rds("graph_files/graph_race_seven.RDS")
View(popup_test)
runApp()
tibble::enframe(p_all) %>% tidyr::pivot_wider() %>% t()
{input <- "val_pob_us_regions"
tract_df <- pob_values
scale_bool <- T
}
{
tract_df <- tract_df %>% st_as_sf()
selected_val <- str_sub(input, start = 5)
tract_df$current_data <- tract_df[[input]]
# reading in the data
p_all <- paste0("./graph_files/", list.files(path = "./graph_files/", pattern = selected_val)) %>% readRDS()
p_tracts <-tibble::enframe(p_all) %>% tidyr::pivot_wider() %>% t()
tract_df <- tract_df %>%
mutate(pie_graph = p_tracts)
NUM_VARIABLES <- tract_df %>%
select(starts_with(selected_val)) %>%
ncol() - 1
max_val <- 1 - (1/(NUM_VARIABLES))
jank_minimum <- tract_df[tract_df$NAME == 'Census Tract 9815.01, Suffolk County, Massachusetts',]
jank_minimum$current_data <- 0
#jank_minimum$geometry <- list(list(c(-71.136596, -71.136273, 42.360161, 42.360903)))
jank_minimum$NAME <- 'min_val'
tract_df <- rbind(jank_minimum %>% st_as_sf(), tract_df)
jank_max <- tract_df[tract_df$NAME == 'Census Tract 9813, Suffolk County, Massachusetts',]
jank_max$current_data <- max_val
jank_max$NAME <- 'max_val'
tract_df <- rbind(jank_max, tract_df)
#tract_df <- tract_df %>% st_as_sf()
pal_option <- "RdYlBu"
# pal_option <- addalpha(pal_option, alpha = .5)
#pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
if (scale_bool){
#####FIGURE OUT WHY I NEED TO SUBTRACT 1
pal <- colorNumeric(palette = pal_option, domain = c(0, max_val),
na.color = "#505050")
legend_label <- "Diversity Index Score"
}else {
pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
legend_label <- "Percentile of Diversity Index"
}
}
tract_df %>%
mutate(current_data = ifelse(startsWith(NAME, "Census Tract 98"), NaN,current_data)) %>%
st_transform(crs = "+init=epsg:4326") %>%
leaflet() %>%
addTiles() %>%
addProviderTiles(provider = "CartoDB.Positron")  %>%
addPolygons(
stroke = F,
smoothFactor = 0,
fillOpacity = 0.7,
color = ~ pal(current_data), group = 'current_data',
popup = popupGraph(pie_graphs)
) %>%
addLegend("bottomright",
pal = pal,
values = ~ current_data,
title = legend_label,
opacity = 1,
na.label = 'Tracts with little or no population')
tract_df %>%
mutate(current_data = ifelse(startsWith(NAME, "Census Tract 98"), NaN,current_data)) %>%
st_transform(crs = "+init=epsg:4326") %>%
leaflet() %>%
addTiles() %>%
addProviderTiles(provider = "CartoDB.Positron")  %>%
addPolygons(
stroke = F,
smoothFactor = 0,
fillOpacity = 0.7,
color = ~ pal(current_data), group = 'current_data',
popup = popupGraph(pie_graph)
) %>%
addLegend("bottomright",
pal = pal,
values = ~ current_data,
title = legend_label,
opacity = 1,
na.label = 'Tracts with little or no population')
View(tract_df)
rm(list = ls())
lang_diversity_tract <- readRDS("~/GitHub/Diversity-Map/output/lang_diversity_tract.RDS")
pob_diversity_tract <- readRDS("~/GitHub/Diversity-Map/output/pob_diversity_tract.RDS")
{input <- "val_pob_us_regions"
tract_df <- pob_diversity_tract
scale_bool <- T
}
tract_df <- tract_df %>% st_as_sf()
selected_val <- str_sub(input, start = 5)
tract_df$current_data <- tract_df[[input]]
# reading in the data
p_all <- paste0("./graph_files/", list.files(path = "./graph_files/", pattern = selected_val)) %>% readRDS()
View(p_all)
tibble::enframe(p_all) %>% tidyr::pivot_wider() %>% t()
p_tracts <-tibble::enframe(p_all) %>% tidyr::pivot_wider() %>% t()
tract_df %>%
mutate(p_all = p_tracts)
tract_df %>%
cbind(p_tracts)
tract_df <- tract_df %>%
cbind(p_tracts)
View(tract_df)
tract_df$p_tracts[1]
NUM_VARIABLES <- tract_df %>%
select(starts_with(selected_val)) %>%
ncol() - 1
max_val <- 1 - (1/(NUM_VARIABLES))
jank_minimum <- tract_df[tract_df$NAME == 'Census Tract 9815.01, Suffolk County, Massachusetts',]
jank_minimum$current_data <- 0
#jank_minimum$geometry <- list(list(c(-71.136596, -71.136273, 42.360161, 42.360903)))
jank_minimum$NAME <- 'min_val'
tract_df <- rbind(jank_minimum %>% st_as_sf(), tract_df)
jank_max <- tract_df[tract_df$NAME == 'Census Tract 9813, Suffolk County, Massachusetts',]
jank_max$current_data <- max_val
jank_max$NAME <- 'max_val'
tract_df <- rbind(jank_max, tract_df)
#tract_df <- tract_df %>% st_as_sf()
pal_option <- "RdYlBu"
# pal_option <- addalpha(pal_option, alpha = .5)
#pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
if (scale_bool){
#####FIGURE OUT WHY I NEED TO SUBTRACT 1
pal <- colorNumeric(palette = pal_option, domain = c(0, max_val),
na.color = "#505050")
legend_label <- "Diversity Index Score"
}else {
pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
legend_label <- "Percentile of Diversity Index"
tract_df %>%
mutate(current_data = ifelse(startsWith(NAME, "Census Tract 98"), NaN,current_data)) %>%
st_transform(crs = "+init=epsg:4326") %>%
leaflet() %>%
addTiles() %>%
addProviderTiles(provider = "CartoDB.Positron")  %>%
addPolygons(
stroke = F,
smoothFactor = 0,
fillOpacity = 0.7,
color = ~ pal(current_data), group = 'current_data',
popup = popupGraph(p_tracts)
) %>%
addLegend("bottomright",
pal = pal,
values = ~ current_data,
title = legend_label,
opacity = 1,
na.label = 'Tracts with little or no population')
legend_label <- "Percentile of Diversity Index"
shiny::runApp('mapnew')
{input <- "val_pob_us_regions"
tract_df <- pob_diversity_tract
scale_bool <- T
}
{
tract_df <- tract_df %>% st_as_sf()
selected_val <- str_sub(input, start = 5)
tract_df$current_data <- tract_df[[input]]
# reading in the data
p_all <- paste0("./graph_files/", list.files(path = "./graph_files/", pattern = selected_val)) %>% readRDS()
p_tracts <-tibble::enframe(p_all) %>% tidyr::pivot_wider() %>% t()
tract_df <- tract_df %>%
mutate(pie_graph = p_tracts)
NUM_VARIABLES <- tract_df %>%
select(starts_with(selected_val)) %>%
ncol() - 1
max_val <- 1 - (1/(NUM_VARIABLES))
jank_minimum <- tract_df[tract_df$NAME == 'Census Tract 9815.01, Suffolk County, Massachusetts',]
jank_minimum$current_data <- 0
#jank_minimum$geometry <- list(list(c(-71.136596, -71.136273, 42.360161, 42.360903)))
jank_minimum$NAME <- 'min_val'
tract_df <- rbind(jank_minimum %>% st_as_sf(), tract_df)
jank_max <- tract_df[tract_df$NAME == 'Census Tract 9813, Suffolk County, Massachusetts',]
jank_max$current_data <- max_val
jank_max$NAME <- 'max_val'
tract_df <- rbind(jank_max, tract_df)
#tract_df <- tract_df %>% st_as_sf()
pal_option <- "RdYlBu"
# pal_option <- addalpha(pal_option, alpha = .5)
#pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
if (scale_bool){
#####FIGURE OUT WHY I NEED TO SUBTRACT 1
pal <- colorNumeric(palette = pal_option, domain = c(0, max_val),
na.color = "#505050")
legend_label <- "Diversity Index Score"
}else {
pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
legend_label <- "Percentile of Diversity Index"
}
}
library(tidycensus)
library(tidyverse)
library(leaflet)
library(leafpop)
library(mapview)
library(sf)
library(stringr)
library(plotly)
library(readr)
library(readxl)
library(stringr)
library(dplyr)
library(htmlwidgets)
tract_df %>%
mutate(current_data = ifelse(startsWith(NAME, "Census Tract 98"), NaN,current_data)) %>%
st_transform(crs = "+init=epsg:4326") %>%
leaflet() %>%
addTiles() %>%
addProviderTiles(provider = "CartoDB.Positron")  %>%
addPolygons(
stroke = F,
smoothFactor = 0,
fillOpacity = 0.7,
color = ~ pal(current_data), group = 'current_data',
popup = popupGraph(p_all, type = "html")
) %>%
addLegend("bottomright",
pal = pal,
values = ~ current_data,
title = legend_label,
opacity = 1,
na.label = 'Tracts with little or no population')
{input <- "val_pob_us_regions"
tract_df <- pob_diversity_tract
scale_bool <- T
}
{
tract_df <- tract_df %>% st_as_sf()
selected_val <- str_sub(input, start = 5)
tract_df$current_data <- tract_df[[input]]
# reading in the data
p_all <- paste0("./graph_files/", list.files(path = "./graph_files/", pattern = selected_val)) %>% readRDS()
p_tracts <-tibble::enframe(p_all) %>% tidyr::pivot_wider() %>% t()
tract_df <- tract_df %>%
mutate(pie_graph = p_tracts)
NUM_VARIABLES <- tract_df %>%
select(starts_with(selected_val)) %>%
ncol() - 1
max_val <- 1 - (1/(NUM_VARIABLES))
jank_minimum <- tract_df[tract_df$NAME == 'Census Tract 9815.01, Suffolk County, Massachusetts',]
jank_minimum$current_data <- 0
#jank_minimum$geometry <- list(list(c(-71.136596, -71.136273, 42.360161, 42.360903)))
jank_minimum$NAME <- 'min_val'
tract_df <- rbind(jank_minimum %>% st_as_sf(), tract_df)
jank_max <- tract_df[tract_df$NAME == 'Census Tract 9813, Suffolk County, Massachusetts',]
jank_max$current_data <- max_val
jank_max$NAME <- 'max_val'
tract_df <- rbind(jank_max, tract_df)
#tract_df <- tract_df %>% st_as_sf()
pal_option <- "RdYlBu"
# pal_option <- addalpha(pal_option, alpha = .5)
#pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
if (scale_bool){
#####FIGURE OUT WHY I NEED TO SUBTRACT 1
pal <- colorNumeric(palette = pal_option, domain = c(0, max_val),
na.color = "#505050")
legend_label <- "Diversity Index Score"
}else {
pal <- colorQuantile(palette = pal_option, domain = tract_df$current_data, n = 5)
legend_label <- "Percentile of Diversity Index"
}
}
tract_df %>%
mutate(current_data = ifelse(startsWith(NAME, "Census Tract 98"), NaN,current_data)) %>%
st_transform(crs = "+init=epsg:4326") %>%
leaflet() %>%
addTiles() %>%
addProviderTiles(provider = "CartoDB.Positron")  %>%
addPolygons(
stroke = F,
smoothFactor = 0,
fillOpacity = 0.7,
color = ~ pal(current_data), group = 'current_data',
popup = popupGraph(p_all, type = "html")
) %>%
addLegend("bottomright",
pal = pal,
values = ~ current_data,
title = legend_label,
opacity = 1,
na.label = 'Tracts with little or no population')
